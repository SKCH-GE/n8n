services:
  postgres:
    image: postgres:15
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped

  qdrant:
    image: qdrant/qdrant:latest
    # Expose the HTTP API to the host for local testing; optional.
    ports:
      - "6333:6333"
    volumes:
      - qdrant_storage:/qdrant/storage
    restart: unless-stopped

  n8n:
    image: n8nio/n8n:latest
    environment:
      # Postgres DB config
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=${POSTGRES_DB}
      - DB_POSTGRESDB_USER=${POSTGRES_USER}
      - DB_POSTGRESDB_PASSWORD=${POSTGRES_PASSWORD}

      # n8n host & port for internal networking (these can remain defaults)
      - N8N_HOST=localhost
      - N8N_PORT=5678
      - N8N_PROTOCOL=http

      # IMPORTANT: public webhook base (set to your provided ngrok URL)
      - WEBHOOK_URL=${WEBHOOK_URL}

      # security (optional; enable if you set values in .env)
      - N8N_BASIC_AUTH_ACTIVE=${N8N_BASIC_AUTH_ACTIVE}
      - N8N_BASIC_AUTH_USER=${N8N_BASIC_AUTH_USER}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_BASIC_AUTH_PASSWORD}

      # helpful for reverse proxy / tunnels
      - N8N_PROXY_HOPS=1
    ports:
      - "5678:5678"  # local editor UI access
    volumes:
      - n8n_data:/home/node/.n8n
    depends_on:
      - postgres
    restart: unless-stopped

# Optional ngrok service:
# If you later want ngrok in the compose stack to create/refresh the tunnel from inside Docker,
# uncomment and supply NGROK_AUTHTOKEN, or use a reserved NGROK_HOSTNAME (paid ngrok feature).
#
# ngrok:
#   image: ngrok/ngrok:latest
#   command: ["http", "--authtoken", "${NGROK_AUTHTOKEN}", "--log", "stdout", "http://n8n:5678"]
#   environment:
#     - NGROK_AUTHTOKEN=${NGROK_AUTHTOKEN}
#   depends_on:
#     - n8n
#   restart: unless-stopped

volumes:
  postgres_data:
  qdrant_storage:
  n8n_data:
